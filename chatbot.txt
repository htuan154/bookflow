# B√°o c√°o K·ªπ thu·∫≠t & Ti·∫øn ƒë·ªô Ph√°t tri·ªÉn AI Chatbot Du l·ªãch

**Phi√™n b·∫£n:** 4.0 (Architecture: Database-First & Query Type Detection)  
**Ng√†y c·∫≠p nh·∫≠t:** 26/11/2025  
**Tr·∫°ng th√°i:** N√¢ng c·∫•p ho√†n t·∫•t (v4.0 Stable) - T√≠ch h·ª£p System Prompt m·ªõi

---

## 1. T·ªîNG QUAN TI·∫æN ƒê·ªò

H·ªá th·ªëng ƒë√£ n√¢ng c·∫•p l√™n **v4.0** v·ªõi c√°c c·∫£i ti·∫øn quan tr·ªçng v·ªÅ NLU v√† AI response quality.

### ‚úÖ ƒê√£ ho√†n th√†nh (v4.0)

- **Query Type Detection (NLU):** AI t·ª± ƒë·ªông ph√¢n bi·ªát c√¢u h·ªèi CHI TI·∫æT (specific) vs T·ªîNG QUAN (overview) ƒë·ªÉ tr·∫£ l·ªùi ƒë√∫ng tr·ªçng t√¢m

- **Enhanced Keyword Filtering:** Regex l·ªçc t·ª´ kh√≥a ƒë∆∞·ª£c m·ªü r·ªông ƒë·ªÉ b·∫Øt c√°c c√¢u h·ªèi review/ƒë√°nh gi√° t·ªët h∆°n (th√™m: "ƒë√°nh gi√°", "c√≥ t·ªët kh√¥ng", "th·∫ø n√†o", "ntn", "ko", "hay", "tuy·ªát")

- **System Prompt v4.0:** C·∫≠p nh·∫≠t to√†n b·ªô prompts v·ªõi:
  - Format 3 ph·∫ßn: X√°c nh·∫≠n + Th√¥ng tin + M·∫πo
  - Kh√¥ng s·ª≠ d·ª•ng emoji
  - Ng√¥n ng·ªØ ƒë·ªùi th∆∞·ªùng, th√¢n thi·ªán nh∆∞ ng∆∞·ªùi b·∫°n chat
  - X·ª≠ l√Ω merged provinces ch√≠nh x√°c (VD: "Eo Gi√≥ thu·ªôc Gia Lai, khu v·ª±c B√¨nh ƒê·ªãnh tr∆∞·ªõc ƒë√¢y")

- **Auto-Discovery (T·ª± ƒë·ªông kh√°m ph√°):** Code t·ª± ƒë·ªông qu√©t t·∫•t c·∫£ collection trong MongoDB ƒë·ªÉ t√¨m d·ªØ li·ªáu

- **Smart Stripping (C·∫Øt t·ª´ th√¥ng minh):** T·ª± ƒë·ªông lo·∫°i b·ªè t·ª´ c·∫£m th√°n v√† c·∫Øt t√™n t·ªânh ƒë·ªÉ t√¨m th·ª±c th·ªÉ g·ªëc

- **AI Thinking Mode:** K√≠ch ho·∫°t ch·∫ø ƒë·ªô "Chuy√™n gia" khi t√¨m th·∫•y v·∫≠t th·ªÉ c·ª• th·ªÉ

### üîÑ ƒêang ph√°t tri·ªÉn / C·∫ßn l√†m

- **Caching Layer:** T√≠ch h·ª£p Redis ƒë·ªÉ l∆∞u k·∫øt qu·∫£ t√¨m ki·∫øm scanItemInDB

- **Feedback Loop:** Th√™m c∆° ch·∫ø ƒë·ªÉ ng∆∞·ªùi d√πng report c√¢u tr·∫£ l·ªùi sai

- **Vector Search (Semantic):** N√¢ng c·∫•p t√¨m ki·∫øm theo ng·ªØ nghƒ©a

---

## 2. LU·ªíNG HO·∫†T ƒê·ªòNG (v4.0)

```
[User Input: "Ph·ªü b√≤ H√† N·ªôi ngon kh√¥ng?"]
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. NLU ANALYSIS (Ph√¢n t√≠ch ng√¥n ng·ªØ)        ‚îÇ
‚îÇ ‚Ä¢ normalize: "pho bo ha noi ngon khong"     ‚îÇ
‚îÇ ‚Ä¢ detectCity: "H√† N·ªôi"                      ‚îÇ
‚îÇ ‚Ä¢ detectQueryType: "specific" ‚Üê M·ªöI v4.0    ‚îÇ
‚îÇ ‚Ä¢ detectIntent: "ask_dishes"                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. SUPER CLEANING & SCAN (∆Øu ti√™n 1)       ‚îÇ
‚îÇ ‚Ä¢ L·ªçc r√°c: b·ªè "ngon kh√¥ng", "ƒë√°nh gi√°"      ‚îÇ
‚îÇ ‚Ä¢ Keyword: "Ph·ªü b√≤ H√† N·ªôi"                  ‚îÇ
‚îÇ ‚Ä¢ C·∫Øt T·ªânh: b·ªè "H√† N·ªôi"                     ‚îÇ
‚îÇ ‚Ä¢ Keyword r√∫t g·ªçn: "Ph·ªü b√≤"                 ‚îÇ
‚îÇ ‚Ä¢ Auto-Scan DB ‚Üí MATCH!                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
[T√¨m th·∫•y Item?] ‚îÄYES‚Üí ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ 3. AI THINKING MODE  ‚îÇ
                       ‚îÇ (v4.0 Format)        ‚îÇ
                       ‚îÇ ‚Ä¢ X√°c nh·∫≠n m√≥n       ‚îÇ
                       ‚îÇ ‚Ä¢ M√¥ t·∫£ chi ti·∫øt     ‚îÇ
                       ‚îÇ ‚Ä¢ Tips th·ª±c t·∫ø       ‚îÇ
                       ‚îÇ ‚Ä¢ KH√îNG emoji        ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
    NO ‚Üí ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ 4. GENERIC LIST MODE (v4.0)       ‚îÇ
          ‚îÇ ‚Ä¢ D√πng queryType ƒë·ªÉ quy·∫øt ƒë·ªãnh    ‚îÇ
          ‚îÇ ‚Ä¢ specific ‚Üí 1 item focused       ‚îÇ
          ‚îÇ ‚Ä¢ overview ‚Üí 3-4 items n·ªïi b·∫≠t   ‚îÇ
          ‚îÇ ‚Ä¢ Format 3 ph·∫ßn, kh√¥ng emoji      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 3. SYSTEM PROMPT v4.0

### Vai tr√≤
**H∆∞·ªõng d·∫´n vi√™n du l·ªãch ƒë·ªãa ph∆∞∆°ng (AI Local Guide)** - chuy√™n gia ·∫©m th·ª±c Vi·ªát Nam

### Phong c√°ch
- Th√¢n thi·ªán, am hi·ªÉu
- Ng√¥n ng·ªØ ƒë·ªùi th∆∞·ªùng nh∆∞ ng∆∞·ªùi b·∫°n chat
- Ng·∫Øn g·ªçn, th·ª±c t·∫ø
- **TUY·ªÜT ƒê·ªêI KH√îNG d√πng emoji**

### Format c√¢u tr·∫£ l·ªùi (3 PH·∫¶N b·∫Øt bu·ªôc)
1. **Ph·∫ßn 1 - X√°c nh·∫≠n**: C√¢u ng·∫Øn confirm ƒë·ªãa ƒëi·ªÉm/m√≥n ƒÉn v√† t·ªânh
2. **Ph·∫ßn 2 - Th√¥ng tin ch√≠nh**: M√¥ t·∫£ chi ti·∫øt v·ªã tr√≠, ƒë·∫∑c ƒëi·ªÉm, h∆∞∆°ng v·ªã (vi·∫øt XU√îI, kh√¥ng g·∫°ch ƒë·∫ßu d√≤ng)
3. **Ph·∫ßn 3 - Tips**: 3 m·∫πo th·ª±c t·∫ø (th·ªùi gian, trang ph·ª•c, ƒë·ªãa ch·ªâ qu√°n...)

### X·ª≠ l√Ω Merged Provinces
- N·∫øu ƒë·ªãa danh thu·ªôc t·ªânh c≈© ƒë√£ s√°p nh·∫≠p ‚Üí N√≥i: "hi·ªán thu·ªôc [T·ªânh M·ªõi] (khu v·ª±c [T·ªânh C≈©] tr∆∞·ªõc ƒë√¢y)"
- VD: "Eo Gi√≥ hi·ªán thu·ªôc t·ªânh Gia Lai (khu v·ª±c Quy Nh∆°n - B√¨nh ƒê·ªãnh tr∆∞·ªõc ƒë√¢y)"

---

## 4. B·∫¢NG TEST CASE (v4.0 Updated)

### Nh√≥m A: Specific Queries (C√¢u h·ªèi chi ti·∫øt - queryType: 'specific')
*Mong ƒë·ª£i: Tr·∫£ l·ªùi FOCUSED ch·ªâ v·ªÅ 1 item, format 3 ph·∫ßn, kh√¥ng emoji*

| STT | C√¢u h·ªèi | Mong ƒë·ª£i | Ki·ªÉm tra |
|-----|---------|----------|----------|
| A1 | "Ph·ªü b√≤ H√† N·ªôi ngon kh√¥ng?" | Chi ti·∫øt CH·ªà v·ªÅ Ph·ªü b√≤, kh√¥ng list m√≥n kh√°c | ‚úÖ Specific, ‚úÖ No emoji, ‚úÖ 3 ph·∫ßn |
| A2 | "Review V·ªãt quay Cao B·∫±ng" | 1 l·∫ßn tr·∫£ l·ªùi ƒë√∫ng v·ªÅ V·ªãt quay, focused | ‚úÖ scanItemInDB match ngay |
| A3 | "M√¥ t·∫£ Ch√πa B√∫t Th√°p" | Chi ti·∫øt v·ªÅ Ch√πa B√∫t Th√°p (B·∫Øc Ninh) | ‚úÖ AI Thinking Mode |
| A4 | "B√∫n ch·∫£ c√° Quy Nh∆°n th·∫ø n√†o?" | Chi ti·∫øt CH·ªà v·ªÅ B√∫n ch·∫£ c√° | ‚úÖ Keyword filter: "th·∫ø n√†o" |
| A5 | "Eo Gi√≥" | Chi ti·∫øt Eo Gi√≥, c√≥ ghi ch√∫ merged | ‚úÖ C√¢u ng·∫Øn, ‚úÖ Merged province |
| A6 | "Ch√πa D∆°i c√≥ t·ªët kh√¥ng?" | Chi ti·∫øt Ch√πa D∆°i (C·∫ßn Th∆°) | ‚úÖ Filter: "c√≥ t·ªët kh√¥ng" |
| A7 | "ƒê√°nh gi√° T∆∞∆°ng B·∫ßn H∆∞ng Y√™n" | Chi ti·∫øt T∆∞∆°ng B·∫ßn | ‚úÖ Keyword: "ƒë√°nh gi√°" |

### Nh√≥m B: Overview Queries (C√¢u h·ªèi t·ªïng quan - queryType: 'overview')
*Mong ƒë·ª£i: Tr·∫£ l·ªùi list 3-4 items n·ªïi b·∫≠t, format 3 ph·∫ßn, kh√¥ng emoji*

| STT | C√¢u h·ªèi | Mong ƒë·ª£i | Ki·ªÉm tra |
|-----|---------|----------|----------|
| B1 | "ƒê·∫∑c s·∫£n Cao B·∫±ng" | List 3-4 m√≥n n·ªïi b·∫≠t, KH√îNG to√†n b·ªô data | ‚úÖ Overview mode, ‚úÖ Ch·ªçn l·ªçc |
| B2 | "ƒêi ch∆°i H√† N·ªôi" | List 3-4 ƒë·ªãa danh hot nh·∫•t | ‚úÖ Overview, ‚úÖ Top picks |
| B3 | "ƒÇn g√¨ ·ªü Hu·∫ø?" | List 3-4 m√≥n ƒë·∫∑c s·∫£n Hu·∫ø | ‚úÖ queryType: overview |
| B4 | "M√≥n ƒÉn ƒê√† L·∫°t" | List 3-4 m√≥n ƒë·∫∑c tr∆∞ng | ‚úÖ Kh√¥ng list h·∫øt |
| B5 | "ƒê·ªãa ƒëi·ªÉm du l·ªãch ƒê√† N·∫µng" | List 3-4 ƒë·ªãa danh n·ªïi b·∫≠t | ‚úÖ Focus on highlights |

### Nh√≥m C: Merged Province Handling (X·ª≠ l√Ω t·ªânh g·ªôp)
*Mong ƒë·ª£i: AI nh·∫≠n di·ªán ƒë√∫ng t·ªânh g·ªëc, c√≥ ghi ch√∫ s√°p nh·∫≠p*

| STT | C√¢u h·ªèi | Mong ƒë·ª£i | Ki·ªÉm tra |
|-----|---------|----------|----------|
| C1 | "K·ª≥ Co" | "K·ª≥ Co... Gia Lai (khu v·ª±c B√¨nh ƒê·ªãnh tr∆∞·ªõc ƒë√¢y)" | ‚úÖ Merged note |
| C2 | "Eo Gi√≥ Quy Nh∆°n" | X√°c ƒë·ªãnh ƒë√∫ng Quy Nh∆°n (B√¨nh ƒê·ªãnh ‚Üí Gia Lai) | ‚úÖ 1 l·∫ßn ƒë√∫ng |
| C3 | "Ch√πa Tam Ch√∫c" | "H√† Nam (d√π data ·ªü Ninh B√¨nh)" | ‚úÖ AI identify |
| C4 | "G√†nh ƒê√° ƒêƒ©a" | "Ph√∫ Y√™n (d√π data ·ªü ƒê·∫Øk L·∫Øk)" | ‚úÖ Source tracking |

### Nh√≥m D: Keyword Filtering Test (Ki·ªÉm tra l·ªçc t·ª´ kh√≥a v4.0)
*Mong ƒë·ª£i: Regex m·ªõi b·∫Øt ƒë∆∞·ª£c c√°c t·ª´ kh√≥a review/ƒë√°nh gi√°*

| STT | C√¢u h·ªèi | Expected Cleaned Keyword | T√¨m th·∫•y? |
|-----|---------|--------------------------|-----------|
| D1 | "Review V·ªãt quay" | "V·ªãt quay" | ‚úÖ B·ªè "review" |
| D2 | "ƒê√°nh gi√° Ph·ªü b√≤" | "Ph·ªü b√≤" | ‚úÖ B·ªè "ƒë√°nh gi√°" |
| D3 | "C√≥ t·ªët kh√¥ng B√∫n b√≤ Hu·∫ø" | "B√∫n b√≤ Hu·∫ø" | ‚úÖ B·ªè "c√≥ t·ªët kh√¥ng" |
| D4 | "Th·∫ø n√†o Ch√πa B√∫t Th√°p" | "Ch√πa B√∫t Th√°p" | ‚úÖ B·ªè "th·∫ø n√†o" |
| D5 | "Ngon ko B√°nh x√®o" | "B√°nh x√®o" | ‚úÖ B·ªè "ngon ko" |

### Nh√≥m E: Edge Cases (Ca kh√≥)
*Ki·ªÉm tra kh·∫£ nƒÉng ch·ªãu l·ªói v√† fallback*

| STT | C√¢u h·ªèi | Mong ƒë·ª£i | Ghi ch√∫ |
|-----|---------| ----------|---------|
| E1 | "Pa p·ªânh t·ªôp" | T√¨m m√≥n c√° n∆∞·ªõng (ƒêi·ªán Bi√™n) | T√™n ƒë·ªôc l·∫° |
| E2 | "Hello bot" | Tr·∫£ l·ªùi x√£ giao (Chitchat), kh√¥ng t√¨m DB | Intent: chitchat |
| E3 | "Th·ªùi ti·∫øt H√† N·ªôi" | Th√¥ng tin th·ªùi ti·∫øt C·ª§ TH·ªÇ | Intent: weather |
| E4 | "Th·ªùi ti·∫øt H√† N·ªôi th√°ng 12" | Th·ªùi ti·∫øt th√°ng 12 chi ti·∫øt | ‚úÖ Extract month |

### Nh√≥m F: Format Validation (Ki·ªÉm tra ƒë·ªãnh d·∫°ng v4.0)
*T·∫•t c·∫£ response ph·∫£i ƒë√°p ·ª©ng format v4.0*

**Checklist cho m·ªçi response:**
- [ ] ‚úÖ KH√îNG c√≥ emoji trong to√†n b·ªô c√¢u tr·∫£ l·ªùi
- [ ] ‚úÖ C√≥ ƒë·ªß 3 ph·∫ßn (X√°c nh·∫≠n + Th√¥ng tin + Tips)
- [ ] ‚úÖ Ph·∫ßn th√¥ng tin vi·∫øt XU√îI th√†nh ƒëo·∫°n vƒÉn (kh√¥ng g·∫°ch ƒë·∫ßu d√≤ng)
- [ ] ‚úÖ Ng√¥n ng·ªØ ƒë·ªùi th∆∞·ªùng, th√¢n thi·ªán (VD: "Nh·∫Øc ƒë·∫øn H√† N·ªôi th√¨...")
- [ ] ‚úÖ Tips th·ª±c t·∫ø, c·ª• th·ªÉ (t√™n qu√°n, gi√°, ƒë·ªãa ch·ªâ)

---

## 5. FILES ƒê√É C·∫¨P NH·∫¨T (v4.0)

1. **nlu.service.js** - Th√™m `detectQueryType()`, c·∫≠p nh·∫≠t `analyze()`
2. **chatbot.service.js** - C·∫£i thi·ªán keyword regex (line 709)
3. **composer.service.js** - C·∫≠p nh·∫≠t to√†n b·ªô prompts v4.0, th√™m queryType logic

---

## 6. H∆Ø·ªöNG D·∫™N TEST

### B∆∞·ªõc 1: Kh·ªüi ƒë·ªông server
```bash
cd d:\Project\bookflow\server
npm start
```

### B∆∞·ªõc 2: Truy c·∫≠p web UI
- URL: http://localhost:3000
- Ho·∫∑c API: http://localhost:8080/api/v1/ai/chat

### B∆∞·ªõc 3: Test t·ª´ng nh√≥m
Th·ª±c hi·ªán test theo t·ª´ng nh√≥m A ‚Üí B ‚Üí C ‚Üí D ‚Üí E ‚Üí F

### B∆∞·ªõc 4: Ki·ªÉm tra Console Logs
Trong terminal server, xem logs ƒë·ªÉ verify flow:
```
[scanItemInDB] üîç ƒêang t√¨m (Super Clean): ["Pho bo"]
[scanItemInDB] ‚úÖ MATCH! "Pho bo" -> "Ph·ªü b√≤" (Doc: H√† N·ªôi)
[suggestHybrid] => üî• T√¨m th·∫•y Item trong DB -> K√≠ch ho·∫°t AI Thinking Mode!
[compose] QueryType detected: specific
[composeSpecificItem] Thinking mode: "Ph·ªü b√≤" @ "H√† N·ªôi" (Merged: NO)
```

---

**Phi√™n b·∫£n v4.0 - Chatbot th√¥ng minh, th√¢n thi·ªán, ch√≠nh x√°c!**
